<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Babysitting Round Robin — Drag & Drop Calendar</title>
<style>
  :root{
    --bg:#ffffff; --panel:#f8fafc; --soft:#e5e7eb; --muted:#374151; --text:#0b1220; --accent:#0ea5a5; --ok:#16a34a; --warn:#f97316; --err:#ef4444;
    --chip:#eef2ff; --chipBr:#c7d2fe; --grid:#e5e7eb; --drop:#cbd5e1;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--text); background:var(--bg); }
  header{ padding:20px; border-bottom:1px solid var(--soft); background:#ffffff; position:sticky; top:0; z-index:1; }
  h1{ margin:0; font-size:22px }
  main{ width:100%; max-width:none; margin:0 auto; padding:20px 24px; display:grid; gap:20px; grid-template-columns: 320px minmax(700px, 1fr) }
  .panel{ background:var(--panel); border:1px solid var(--soft); border-radius:16px; padding:14px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  label{ display:block; color:var(--muted); font-size:12px; margin-bottom:6px }
  input,button{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--soft); background:#ffffff; color:#0b1220; outline:none }
  button{ cursor:pointer; font-weight:600 }
  .btn{ background:var(--accent); color:#083344; border:0 }
  .btn.secondary{ background:#e5e7eb; color:#111827 }
  .stack{ display:flex; flex-direction:column; gap:10px }
  .chips{ display:flex; flex-wrap:wrap; gap:8px }
  .chip{ display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid var(--chipBr); padding:6px 10px; border-radius:999px; font-size:13px; user-select:none }
  .draggable{ cursor:grab }
  .calendar{ display:grid; grid-template-columns:repeat(7,1fr); gap:14px }
  .dow{ color:#6b7280; text-align:center; font-size:12px }
  .cell{ min-height:160px; background:#ffffff; border:1px solid var(--grid); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:6px }
  .date{ font-size:12px; color:#111827; display:flex; align-items:center; justify-content:space-between }
  .dropzone{ flex:1; border:1px dashed var(--drop); border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:6px; background:#fafafa }
  .dropzone.highlight{ border-color:var(--ok); box-shadow:inset 0 0 0 1px var(--ok) }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; display:flex; gap:8px; align-items:center; justify-content:space-between }
  .pill.couple{ background:#d1fae5; border:1px solid #a7f3d0 }
  .pill.sitter{ background:#fef3c7; border:1px solid #fde68a }
  .pill .x{ cursor:pointer; font-weight:800; opacity:.85; padding:0 6px; border-radius:999px }
  .pill .x:hover{ background:rgba(0,0,0,.06) }
  .note{ color:#6b7280; font-size:12px }
  .legend{ display:flex; gap:8px; flex-wrap:wrap }
  .legend .pill{ background:#ffffff; border:1px solid var(--grid) }
  .toaster{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:10 }
  .toast{ background:#111827; color:#ecf2ff; border:1px solid #374151; border-radius:10px; padding:10px 12px; font-size:14px }
  .toast.err{ border-color:#7f1d1d; color:#fecaca }
  .monthbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px }
  .monthbar h2{ margin:0; font-size:20px }
  .nav{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .nav .btn.small{ padding:6px 12px; font-size:13px; border-radius:8px }

  /* ===== Mobile tweaks ===== */
  @media (max-width: 900px){
    main{ grid-template-columns: 1fr; padding: 12px }
    .calendar{ gap:10px }
    .cell{ min-height: 130px; padding: 12px }
    #left .panel{ padding:12px }
    .chips{ overflow-x:auto; flex-wrap:nowrap; -webkit-overflow-scrolling: touch }
    .chip{ white-space:nowrap }
  }

  /* ===== Bottom-sheet editor for mobile ===== */
  .sheet{ position: fixed; left:0; right:0; bottom:-100%; background:#ffffff; border-top:1px solid var(--soft); box-shadow:0 -8px 30px rgba(0,0,0,.12); transition: bottom .25s ease; z-index:50; }
  .sheet.open{ bottom:0 }
  .sheet .inner{ padding:16px; max-width:700px; margin:0 auto }
  .sheet h3{ margin:0 0 8px; font-size:16px }
  .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .pill.btn{ justify-content:center; cursor:pointer }
  .btnbar{ display:flex; gap:10px; margin-top:12px }
</style>
</head>
<body>
  <header>
    <h1>Babysitting Round Robin — Drag & Drop Calendar</h1>
  </header>
  <main>
    <section class="panel stack" id="left">
      <div>
        <label>Month</label>
        <div class="row">
          <input type="month" id="monthPicker" />
        </div>
      </div>

      <div class="panel" style="border-style:dashed">
        <div class="stack">
          <div>
            <strong>Couples (drag to a date)</strong>
            <div id="coupleChips" class="chips"></div>
          </div>
          <div>
            <strong>Partners (drag to Sitter)</strong>
            <div id="partnerChips" class="chips"></div>
          </div>
          <p class="note">Rule: sitter must be from a <em>different</em> couple than the one going out. Each couple can go out <em>once per month</em>.</p>
        </div>
      </div>

      <div class="stack">
        <button class="btn secondary" id="clearMonth">Clear this month</button>
      </div>

      <div class="panel" style="border-style:dashed">
        <div class="legend">
          <span class="pill couple">Date Night Couple</span>
          <span class="pill sitter">Sitter (Individual)</span>
        </div>
        <p class="note">Drag a <strong>couple</strong> to a date, then drag any partner from the other two couples onto the sitter area. Remove by clicking × on a pill.</p>
      </div>
    </section>

    <section class="panel" id="right">
      <div class="monthbar">
        <h2 id="monthLabel">Month</h2>
        <div class="nav">
          <button id="prevBtn" class="btn secondary small">‹ Prev</button>
          <button id="nextBtn" class="btn secondary small">Next ›</button>
        </div>
      </div>
      <div class="calendar" id="calendar"></div>
    </section>
  </main>

  <div class="toaster" id="toaster"></div>

  <!-- Mobile bottom-sheet editor -->
  <div class="sheet" id="editor">
    <div class="inner">
      <h3 id="edTitle">Edit</h3>
      <div class="row2">
        <div>
          <label>Date-night couple</label>
          <div id="edCouples" class="chips"></div>
        </div>
        <div>
          <label>Sitter (must be different couple)</label>
          <div id="edSitters" class="chips"></div>
        </div>
      </div>
      <div class="btnbar">
        <button class="btn" id="edSave">Save</button>
        <button class="btn secondary" id="edClear">Clear</button>
        <button class="btn secondary" id="edClose">Close</button>
      </div>
    </div>
  </div>

<script>
// =================== DATA ===================
const COUPLES = [
  { key: 'A', name: 'Addadas', partners: ['Nour Ghadanfar','Tariq Addada'], colorBg:'#a7f3d0', colorBr:'#34d399' },
  { key: 'B', name: 'Bonesteeles', partners: ['Aranza Gonzalez','Grant Bonesteele'], colorBg:'#fde68a', colorBr:'#fbbf24' },
  { key: 'C', name: 'Bradys', partners: ['Lubna Alansari','Travis Brady'], colorBg:'#ddd6fe', colorBr:'#c4b5fd' },
];

// =================== UTIL ===================
const WEEKDAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const FULL_MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
function pad2(n){return String(n).padStart(2,'0');}
function ymKey(dt){return `${dt.getUTCFullYear()}-${pad2(dt.getUTCMonth()+1)}`}
function toast(msg, isErr=false){
  const t = document.createElement('div');
  t.className = 'toast' + (isErr ? ' err' : '');
  t.textContent = msg;
  document.getElementById('toaster').appendChild(t);
  setTimeout(()=>t.remove(), 2200);
}
function findCoupleKeyByPartner(name){
  for (const c of COUPLES){ if (c.partners.includes(name)) return c.key; }
  return null;
}

// =================== STATE ===================
// Stored as: { ["YYYY-MM"]: { ["YYYY-MM-DD"]: { coupleKey, sitterName } } }
let store = {};
try{ store = JSON.parse(localStorage.getItem('bb_rr_store')||'{}'); }catch(e){ store = {}; }
function save(){ localStorage.setItem('bb_rr_store', JSON.stringify(store)); }

// =================== SIDEBAR CHIPS ===================
function renderChips(){
  const coupleWrap = document.getElementById('coupleChips');
  coupleWrap.innerHTML='';
  COUPLES.forEach(c=>{
    const el = document.createElement('div');
    el.className='chip draggable';
    el.draggable=true; el.dataset.type='couple'; el.dataset.couple=c.key;
    el.textContent=c.name;
    el.style.background = c.colorBg;
    el.style.borderColor = c.colorBr;
    coupleWrap.appendChild(el);
  });
  const partnerWrap = document.getElementById('partnerChips');
  partnerWrap.innerHTML='';
  COUPLES.forEach(c=>{
    c.partners.forEach(p=>{
      const el = document.createElement('div');
      el.className='chip draggable';
      el.draggable=true; el.dataset.type='partner'; el.dataset.couple=c.key; el.dataset.name=p;
      el.textContent=p;
      partnerWrap.appendChild(el);
    });
  });
}

// =================== CALENDAR ===================
function firstOfMonthUTC(year, monthIndex){return new Date(Date.UTC(year, monthIndex, 1));}
function daysInMonthUTC(year, monthIndex){return new Date(Date.UTC(year, monthIndex+1, 0)).getUTCDate();}

function buildCalendarGrid(dt){
  const cal = document.getElementById('calendar');
  const label = document.getElementById('monthLabel');
  const ym = ymKey(dt);
  label.textContent = `${FULL_MONTHS[dt.getUTCMonth()]} ${dt.getUTCFullYear()}`;
  cal.innerHTML='';

  // header row with DOW
  WEEKDAYS.forEach(d=>{
    const h = document.createElement('div'); h.className='dow'; h.textContent=d; cal.appendChild(h);
  });

  const y = dt.getUTCFullYear();
  const m = dt.getUTCMonth();
  const first = firstOfMonthUTC(y,m);
  const startOffset = first.getUTCDay();
  const totalDays = daysInMonthUTC(y,m);

  if (!store[ym]) store[ym] = {};

  const makeCell = (dayNum)=>{
    const cell = document.createElement('div'); cell.className='cell';
    if(dayNum===null){ cell.classList.add('ghost'); cell.innerHTML=''; return cell; }
    const dateISO = `${y}-${pad2(m+1)}-${pad2(dayNum)}`;

    const head = document.createElement('div'); head.className='date';
    head.innerHTML = `<span>${dayNum}</span>`;

    const dz = document.createElement('div'); dz.className='dropzone'; dz.dataset.date=dateISO;

    // pill areas
    const coupleSlot = document.createElement('div');
    coupleSlot.className='pill couple';
    coupleSlot.textContent='Drop couple here';

    const sitterSlot = document.createElement('div');
    sitterSlot.className='pill sitter';
    sitterSlot.textContent='Drop sitter here';

    function makePillRemovable(pill, slotType){
      const x = document.createElement('span'); x.className='x'; x.textContent='×';
      x.title = 'Remove'; x.addEventListener('click', ()=>{ clearSlot(dateISO, slotType); rebuildCell(); });
      pill.appendChild(x);
    }

    function clearSlot(date, slotType){
      store[ym][date] = store[ym][date] || {coupleKey:null, sitterName:null};
      if(slotType==='couple'){ store[ym][date].coupleKey = null; store[ym][date].sitterName = null; }
      if(slotType==='sitter'){ store[ym][date].sitterName = null; }
      save();
    }

    function rebuildCell(){
      coupleSlot.textContent='Drop couple here';
      sitterSlot.textContent='Drop sitter here';
      const saved = store[ym][dateISO];
      if(saved && saved.coupleKey){
        const couple = COUPLES.find(c=>c.key===saved.coupleKey);
        coupleSlot.textContent = `${couple.name} — going out`;
        coupleSlot.style.background = couple.colorBg;
        coupleSlot.style.borderColor = couple.colorBr;
        makePillRemovable(coupleSlot,'couple');
        if(saved.sitterName){
          sitterSlot.textContent = `${saved.sitterName} — babysitting`;
          makePillRemovable(sitterSlot,'sitter');
        }
      }
    }

    // preload from store
    rebuildCell();

    dz.appendChild(coupleSlot);
    dz.appendChild(sitterSlot);

    cell.appendChild(head);
    cell.appendChild(dz);

    // === Mobile tap to edit (works on desktop too) ===
    cell.addEventListener('click', ()=>{
      if(window.matchMedia('(pointer: coarse)').matches || window.innerWidth <= 900){
        openEditor(ym, dateISO);
      }
    });

    // === Drag & drop for desktop ===
    dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.classList.add('highlight'); });
    dz.addEventListener('dragleave', ()=>dz.classList.remove('highlight'));
    dz.addEventListener('drop', (e)=>{
      e.preventDefault(); dz.classList.remove('highlight');
      const type = e.dataTransfer.getData('type');
      const fromCouple = e.dataTransfer.getData('couple');
      const name = e.dataTransfer.getData('name');

      store[ym][dateISO] = store[ym][dateISO] || { coupleKey:null, sitterName:null };
      const ref = store[ym][dateISO];

      if(type==='couple'){
        // One outing per couple per month
        const monthEntries = store[ym];
        const already = Object.entries(monthEntries).some(([d,val])=> val && val.coupleKey === fromCouple && d !== dateISO);
        if(already){ const coupleName = COUPLES.find(c=>c.key===fromCouple).name; toast(`${coupleName} already has a date night this month.`, true); return; }
        ref.coupleKey = fromCouple; // set couple
        // reset sitter if sitter belongs to the same couple
        if(ref.sitterName){ const sitterKey = findCoupleKeyByPartner(ref.sitterName); if(sitterKey === fromCouple) ref.sitterName = null; }
        save(); rebuildCell();
      } else if(type==='partner'){
        if(!ref.coupleKey){ toast('Assign a date-night couple first.', true); return; }
        const sitterKey = findCoupleKeyByPartner(name);
        if(!sitterKey || sitterKey === ref.coupleKey){ const coupleName = COUPLES.find(c=>c.key===ref.coupleKey).name; toast(`Invalid sitter: must be from a different couple than ${coupleName}.`, true); return; }
        ref.sitterName = name; save(); rebuildCell();
      }
    });

    return cell;
  };

  for(let i=0;i<startOffset;i++) cal.appendChild(makeCell(null));
  for(let d=1; d<=totalDays; d++) cal.appendChild(makeCell(d));
  const used = 7 + startOffset + totalDays; // 7 headers + cells
  const rem = (used % 7 === 0) ? 0 : (7 - (used % 7));
  for(let i=0;i<rem;i++) cal.appendChild(makeCell(null));
}

// =================== MONTH NAV ===================
function offsetYM(ym, delta){
  const y = Number(ym.slice(0,4)); const m = Number(ym.slice(5));
  const d = new Date(Date.UTC(y, m-1+delta, 1));
  return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}`;
}
function setMonth(ym){
  const picker = document.getElementById('monthPicker');
  picker.value = ym;
  const dt = new Date(Date.UTC(Number(ym.slice(0,4)), Number(ym.slice(5))-1, 1));
  buildCalendarGrid(dt);
}

// =================== GLOBAL DND ===================
function enableGlobalDrag(){
  document.addEventListener('dragstart', (e)=>{
    const t = e.target; if(!t.classList.contains('draggable')) return;
    const type = t.dataset.type || 'assigned';
    e.dataTransfer.setData('type', type);
    if(type==='assigned'){
      e.dataTransfer.setData('slot', t.dataset.slot||'');
      e.dataTransfer.setData('date', t.dataset.date||'');
    } else {
      e.dataTransfer.setData('couple', t.dataset.couple||'');
      e.dataTransfer.setData('name', t.dataset.name||'');
    }
  });
}

// =================== MOBILE EDITOR (bottom sheet) ===================
let edState = { ym:null, dateISO:null, coupleKey:null, sitterName:null };
function openEditor(ym, dateISO){
  edState.ym = ym; edState.dateISO = dateISO;
  if(!store[ym]) store[ym] = {};
  const ref = store[ym][dateISO] || {coupleKey:null, sitterName:null};
  edState.coupleKey = ref.coupleKey; edState.sitterName = ref.sitterName;
  document.getElementById('edTitle').textContent = `Edit ${dateISO}`;

  // Build couple buttons
  const cwrap = document.getElementById('edCouples'); cwrap.innerHTML='';
  COUPLES.forEach(c=>{
    const b = document.createElement('div'); b.className='pill btn'; b.textContent=c.name; b.style.background=c.colorBg; b.style.border=`1px solid ${c.colorBr}`;
    if(edState.coupleKey===c.key) b.style.outline = '2px solid #0ea5a5';
    b.addEventListener('click', ()=>{ edState.coupleKey=c.key; buildSitters(); highlightCouples(); });
    cwrap.appendChild(b);
  });
  function highlightCouples(){ [...cwrap.children].forEach((el,i)=>{ el.style.outline = (COUPLES[i].key===edState.coupleKey)?'2px solid #0ea5a5':'none'; }); }

  // Build sitter buttons (filtered)
  function buildSitters(){
    const swrap = document.getElementById('edSitters'); swrap.innerHTML='';
    const allowed = edState.coupleKey? COUPLES.filter(c=>c.key!==edState.coupleKey) : COUPLES;
    allowed.forEach(c=> c.partners.forEach(p=>{
      const b = document.createElement('div'); b.className='pill btn'; b.textContent=p;
      if(edState.sitterName===p) b.style.outline = '2px solid #0ea5a5';
      b.addEventListener('click', ()=>{ edState.sitterName=p; buildSitters(); });
      swrap.appendChild(b);
    }));
  }
  buildSitters();

  document.getElementById('editor').classList.add('open');
}

(function editorWiring(){
  document.getElementById('edClose').addEventListener('click', ()=> document.getElementById('editor').classList.remove('open'));
  document.getElementById('edClear').addEventListener('click', ()=>{
    if(!store[edState.ym]) store[edState.ym]={};
    store[edState.ym][edState.dateISO] = {coupleKey:null, sitterName:null}; save();
    document.getElementById('editor').classList.remove('open');
    const dt = new Date(Date.UTC(Number(edState.ym.slice(0,4)), Number(edState.ym.slice(5))-1, 1));
    buildCalendarGrid(dt);
  });
  document.getElementById('edSave').addEventListener('click', ()=>{
    if(!store[edState.ym]) store[edState.ym]={};
    const monthEntries = store[edState.ym];
    if(edState.coupleKey){
      const exists = Object.entries(monthEntries).some(([d,val])=> val && val.coupleKey === edState.coupleKey && d !== edState.dateISO);
      if(exists){ const name = COUPLES.find(c=>c.key===edState.coupleKey).name; toast(`${name} already has a date night this month.`, true); return; }
    }
    // Validate sitter/couple difference
    if(edState.sitterName && edState.coupleKey){
      const sitterKey = findCoupleKeyByPartner(edState.sitterName);
      if(sitterKey === edState.coupleKey){ const name = COUPLES.find(c=>c.key===edState.coupleKey).name; toast(`Invalid sitter: must be from a different couple than ${name}.`, true); return; }
    }
    store[edState.ym][edState.dateISO] = { coupleKey: edState.coupleKey||null, sitterName: edState.sitterName||null };
    save(); document.getElementById('editor').classList.remove('open');
    const dt = new Date(Date.UTC(Number(edState.ym.slice(0,4)), Number(edState.ym.slice(5))-1, 1));
    buildCalendarGrid(dt);
  });
})();

// =================== INIT ===================
function offsetYM(ym, delta){
  const y = Number(ym.slice(0,4)); const m = Number(ym.slice(5));
  const d = new Date(Date.UTC(y, m-1+delta, 1));
  return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}`;
}
function setMonth(ym){
  const picker = document.getElementById('monthPicker');
  picker.value = ym;
  const dt = new Date(Date.UTC(Number(ym.slice(0,4)), Number(ym.slice(5))-1, 1));
  buildCalendarGrid(dt);
}
(function init(){
  renderChips(); enableGlobalDrag();
  const picker = document.getElementById('monthPicker');
  const now = new Date();
  const y = now.getFullYear(); const m = now.getMonth()+1; picker.value = `${y}-${pad2(m)}`;
  setMonth(picker.value);
  document.getElementById('prevBtn').addEventListener('click', ()=> setMonth(offsetYM(picker.value, -1)) );
  document.getElementById('nextBtn').addEventListener('click', ()=> setMonth(offsetYM(picker.value, +1)) );
  picker.addEventListener('change', ()=> setMonth(picker.value) );
  document.getElementById('clearMonth').addEventListener('click', ()=>{
    const ym = picker.value; if (!store[ym]) return; if(!confirm('Clear all assignments for this month?')) return;
    delete store[ym]; save(); setMonth(ym);
  });
})();
</script>
</body>
</html>
